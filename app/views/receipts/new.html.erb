<%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
<%= javascript_include_tag 'receipts_functions', 'data-turbolinks-track': true %>
<%= csrf_meta_tags %>

<h1>New Receipt</h1>

<%= form_with model: @receipt do |form|%>
  <div>
    <%= form.label :date %><br>
    <%= form.date_field :date, :value => Time.now.strftime("%Y-%m-%d") %>
    <% @receipt.errors.full_messages_for(:date).each do |message| %>
      <div><%= message %></div>
    <% end %>
  </div>

  <div>
    <%= form.label :comment %><br>
    <%= form.text_field :comment %>
    <% @receipt.errors.full_messages_for(:comment).each do |message| %>
      <div><%= message %></div>
    <% end %>
  </div>

  <div>
    <%= form.label :location %><br>
    <%= form.text_field :location, data: {autocomplete_source: Receipt.distinct.pluck(:location).sort_by { |s| s.downcase }}%>
    <% @receipt.errors.full_messages_for(:location).each do |message| %>
      <div><%= message %></div>
    <% end %>
  </div>

  <div>
    <%= form.label :is_income %><br>
    <%= form.check_box :is_income %>
    <% @receipt.errors.full_messages_for(:is_income).each do |message| %>
      <div><%= message %></div>
    <% end %>
  </div>

  <% if @receipt.errors.has_key? :prices_mismatch %>
    <% @receipt.errors[:prices_mismatch].each do |msg| %>
      <%= msg %>
    <% end %>
  <% end %>
  <% if @receipt.errors.has_key? :duplicate_account %>
    <% @receipt.errors[:duplicate_account].each do |msg| %>
      <%= msg %>
    <% end %>
  <% end %>
  <table>
    <tr>
      <th>Account</th>
      <th>Price</th>
      <th>Remove ?</th>
    </tr>
    <tbody id="receipt_prices">
    <%= form.fields_for :receipt_prices do |price_form| %>
      <%= render "receipt_prices/new", form: price_form %>
    <% end %>
    </tbody>
  </table>
  <div id="receipt_prices_error_messages">
  </div>
  <%= form.submit "Add account",
                  formmethod: "post",
                  formaction: receipt_price_path(@receipt.receipt_prices.size),
                  formnovalidate: true,
                  id: "add-receipt-price"
      %>
  <table>
      <tr>
        <th>Name</th>
        <th>Price</th>
        <th>Quantity</th>
        <th>Category</th>
        <th>Remove ?</th>
      </tr>
    <tbody id="receipt_details">
    <%= form.fields_for :receipt_details do |detail_form| %>
      <%= render "receipt_details/new", form: detail_form %>
    <% end %>
    </tbody>
  </table>
  <div id="receipt_details_error_messages">
  </div>
  <%= form.submit "Add detail",
                  formmethod: "post",
                  formaction: receipt_detail_path(@receipt.receipt_details.size),
                  formnovalidate: true,
                  id: "add-receipt-detail"
  %>

  <table>
    <tr>
      <th>Comment</th>
      <th>Discount</th>
      <th>Remove ?</th>
    </tr>
    <tbody id="receipt_discounts">
    <%= form.fields_for :receipt_discounts do |discount_form| %>
      <%= render "receipt_discounts/new", form: discount_form %>
    <% end %>
    </tbody>
  </table>
  <div id="receipt_discounts_error_messages">
  </div>
  <%= form.submit "Add discount",
                  formmethod: "post",
                  formaction: receipt_discount_path(@receipt.receipt_discounts.size),
                  formnovalidate: true,
                  id: "add-receipt-discount"
  %>

  <div>
    <%= form.submit %>
  </div>
<% end %>
<p><%= link_to "Home", root_path %></p>